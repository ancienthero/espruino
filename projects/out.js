function format(a){return('0'+a).substr(-2);}function syncDcf(a){if(dcfStatus===!1&&(rtc.readDateTime('hours')===2&&rtc.readDateTime('minutes')===1||a===!0)){dcfStatus=!0,B1.write(1),console.log('syncDcf activated');return;}}Modules.removeAllCached(),Modules.addCached('https://github.com/ancienthero/espruino/blob/master/modules/DS3231/DS3231.js',"function DS3231(a,b){this.i2c=a,this.options=b||{},this.options.DST===undefined&&(this.options.DST=!0),this.dstStatus=!1;}function dec2bcd(a){return parseInt(a,16);}function bcd2dec(a){return(a>>4)*10+(a&15);}var C={i2c_address:104,dateReg:4,monthReg:5,yearReg:6,secsReg:0,minsReg:1,hourReg:2,dowReg:3};DS3231.prototype.isDST=function(b,a,c){return this.options.DST?a===3&&c===1&&b>23?!0:a===10&&c===1&&b>23?!1:a>3&&a<11?!0:!1:!1;},DS3231.prototype.setDow=function(c){var b=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];var a=b.indexOf(c);a<0?print('Not a valid day'):this.i2c.writeTo(C.i2c_address,[C.dowReg,dec2bcd(1+a)]);},DS3231.prototype.setDate=function(a,b,c){this.i2c.writeTo(C.i2c_address,[C.dateReg,dec2bcd(a)]),this.i2c.writeTo(C.i2c_address,[C.monthReg,dec2bcd(b)]),this.i2c.writeTo(C.i2c_address,[C.yearReg,dec2bcd(c)]),this.dstStatus=this.isDST(a,b,c);},DS3231.prototype.setTime=function(a,b){this.i2c.writeTo(C.i2c_address,[C.secsReg,0]),this.i2c.writeTo(C.i2c_address,[C.minsReg,dec2bcd(b)]),this.i2c.writeTo(C.i2c_address,[C.hourReg,dec2bcd(a)]);},DS3231.prototype.readDateTime=function(i){this.i2c.writeTo(C.i2c_address,C.secsReg);var a=this.i2c.readFrom(C.i2c_address,7);var f=bcd2dec(a[0]);var c=bcd2dec(a[1]);var b=bcd2dec(a[2]);var g=bcd2dec(a[3]);var d=bcd2dec(a[4]);var e=bcd2dec(a[5]);var h=bcd2dec(a[6]);b===2&&c===0&&f===0&&this.isDST(d,e,g)===!0&&this.dstStatus===!1&&(this.i2c.writeTo(C.i2c_address,[C.hourReg,dec2bcd(2)]),b=3,this.dstStatus=!0),b===3&&c===0&&f===0&&this.isDST(d,e,g)===!1&&this.dstStatus===!0&&(this.i2c.writeTo(C.i2c_address,[C.hourReg,dec2bcd(1)]),b=2,this.dstStatus=!1);switch(i){case'hours':return b;case'minutes':return c;case'dow':return g;case'date':return d;case'month':return e;case'year':return h;default:return new Date(2000+h,e-1,d,b,c,f);}},exports.connect=function(a,b){return new DS3231(a,b);};"),Modules.addCached('DCF77','function c(a){return 1*(0|a[0])+2*(0|a[1])+4*(0|a[2])+8*(0|a[3])}function d(a){for(var c=0,b=0;b<a.length;b++)c^=a[b];return c}function f(a,e){if(d(a.substr(21,7))!=a[28])return e("Bad minutes");var b=c(a.substr(21,4))+10*c(a.substr(25,3));if(d(a.substr(29,6))!=a[35])return e("Bad hours");var g=c(a.substr(29,4))+10*c(a.substr(33,2));if(d(a.substr(36,22))!=a[58])return e("Bad date");var h=c(a.substr(36,4))+10*c(a.substr(40,2));c(a.substr(42,3));var f=c(a.substr(45,4))+10*c(a.substr(49,\n1)),k=c(a.substr(50,4))+10*c(a.substr(54,4));return e(null,new Date(2E3+k,f-1,h,g,b,0,0),{CEST:!!a[17],CET:!!a[18]})}exports.connect=function(a,c){var b={last:getTime(),bits:"",watchId:void 0};b.watchId=setWatch(function(a){var d=.15>a.time-a.lastTime?0:1;1.5<a.time-b.last&&(f(b.bits,c),b.bits="");b.last=a.time;b.bits+=d;59<b.bits.length&&(b.bits=b.bits.substr(-59))},a,{edge:"falling",repeat:!0,debounce:75});return b}');var lastDcf=0,dcfStatus=!1,errCount=0;B1.write(0),I2C1.setup({scl:B6,sda:B7});var rtc=require('https://github.com/ancienthero/espruino/blob/master/modules/DS3231/DS3231.js').connect(I2C1);require('DCF77').connect(A7,function(b,a,c){if(b)digitalPulse(LED1,1,100),console.log('Invalid time received: '+b),errCount++;else{if(digitalPulse(LED1,1,100),!lastDcf){lastDcf=a,console.log('first sync '+a.toString());return;}if(a.getTime()-lastDcf.getTime()===60000*(1+errCount)){console.log('synced '+a.toString()),B1.write(0),dcfStatus=!1,errCount=0,lastDcf=0;return;}lastDcf=a,errCount=0,console.log('lastDcf '+a.toString());}}),setInterval(syncDcf,900);